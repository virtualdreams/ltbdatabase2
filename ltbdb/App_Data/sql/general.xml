<?xml version="1.0" encoding="UTF-8"?>
<sqlMap>
	<select id="getBooks">
		<![CDATA[
		SELECT 
			bookid as id,
			number,
			name,
			stories,
			catid as category,
			(
				select
					c.name
				from
					categories c
				where
					b.catid = c.catid
			) as categoryname,
			added
		FROM 
			books b
		ORDER BY	
			b.number asc
		]]>
	</select>

	<insert id="addBook">
		<![CDATA[
		insert into
			books
		(
			number,
			name,
			stories,
			catid,
			added
		)
		values
		(
			#number#,
			#name#,
			#stories#,
			#category#,
			NOW()
		)
		]]>
	</insert>

	<update id="updateBook">
		<![CDATA[
		update
			books
		set
			number = #number#,
			name = #name#,
			stories = #stories#,
			catid = #category#
		where
			bookid = #id#
		]]>
	</update>
	
	<select id="getCategories">
		<![CDATA[
		select
			catid as id,
			name
		from
			categories
		]]>
	</select>
	<select id="getCategory">
		<![CDATA[
		select
			catid as id,
			name
		from
			categories
		where
			catid = #id#
		]]>
	</select>

	<insert id="addCategory">
		<![CDATA[
		insert into
			categories
		(
			name
		)
		values
		(
			#name#
		)
		]]>
	</insert>
	<update id="updateCategory">
		<![CDATA[
		update 
			categories
		set
			name = #name#
		where
			catid = #id#
		]]>
	</update>
	
	<select id="getTags">
		<![CDATA[
		select
			t.tagid as id,
			t.name,
			count(t2b.tagid) as ref
		from
			tags t
		left outer join
			tag2book t2b
		on
			t2b.tagid = t.tagid
		group by
			t.tagid
		]]>
	</select>
	<select id="getTagById">
		<![CDATA[
		select
			t.tagid as id,
			t.name,
			count(t2b.tagid) as ref
		from
			tags t
		left outer join
			tag2book t2b
		on
			t2b.tagid = t.tagid
		where
			t.tagid = #id#
		group by
			t.tagid
		]]>
	</select>
	<select id="getTagByName">
		<![CDATA[
		select
			t.tagid as id,
			t.name,
			count(t2b.tagid) as ref
		from
			tags t
		left outer join
			tag2book t2b
		on
			t2b.tagid = t.tagid
		where
			t.name = #name#
		group by
			t.tagid
		]]>
	</select>
	<select id="getTagsByBook">
		<![CDATA[
		select
			t.tagid as id,
			t.name,
			count(tt.tagid) as ref
		from
			tags t
		left outer join
			tag2book t2b
		on
			t2b.tagid = t.tagid
		left outer join
			books b
		on
			b.bookid = t2b.bookid
		inner join
			tag2book tt
		on
			tt.tagid = t.tagid
		where
			b.bookid = #id#
		group by
			t.tagid
		]]>
	</select>
	<insert id="addTag">
		<![CDATA[
		insert into
			tags
		(
			name
		)
		values
		(
			#name#
		)
		]]>
	</insert>
	
	<!-- tag 2 book links -->
	
	<select id="getTag2Book">
		<![CDATA[
		select
			tag2book as id,
			tagid,
			bookid
		from
			tag2book
		where
			tag2book = #id#
		]]>
	</select>
	<insert id="addTag2Book">
		<![CDATA[
		insert into
			tag2book
		(
			tagid,
			bookid
		)
		values
		(
			#tagid#,
			#bookid#
		)
		]]>
	</insert>
	<delete id="deleteTag2Book">
		<![CDATA[
		delete from
			tag2book
		where
			tagid = #tagid#
			and bookid = #bookid#
		]]>
	</delete>
	
	<!-- books -->
	
	<select id="getBook">
		<![CDATA[
		SELECT 
			bookid as id,
			number,
			name,
			stories,
			catid as category,
			(
				select
					c.name
				from
					categories c
				where
					b.catid = c.catid
			) as categoryname,
			added
		FROM 
			books b
		where
			bookid = #id#
		]]>
	</select>
	<select id="getBooksByTag">
		<![CDATA[
		select
			b.bookid as id,
			b.number,
			b.name,
			b.stories,
			b.catid as category,
			(
				select
					c.name
				from
					categories c
				where
					b.catid = c.catid
			) as categoryname,
			b.added
		from
			books b
		left outer join
			tag2book t2b
		on
			b.bookid = t2b.bookid
		left outer join
			tags t
		on
			t.tagid = t2b.tagid
		where
			t.tagid = #id#
		ORDER BY	
			b.number asc
		]]>
	</select>
	<select id="getBooksByCategory">
		<![CDATA[
		select
			b.bookid as id,
			b.number,
			b.name,
			b.stories,
			b.catid as category,
			(
				select
					c.name
				from
					categories c
				where
					b.catid = c.catid
			) as categoryname,
			b.added
		from
			books b
		where
			b.catid = #id#
		ORDER BY	
			b.number asc
		]]>
	</select>
	
	<!-- search -->
	
	<select id="getBookByTerm">
		<![CDATA[
		SELECT distinct
			b.bookid as id, 
			b.number,
			b.name, 
			b.stories,
			b.catid as category,
			(
				select 
					c.name 
				from 
					categories c 
				where 
					c.catid = b.catid
			) as categoryname,
			b.added
		FROM 
			books b
		WHERE 
			b.name LIKE #term#
		ORDER BY 
			b.number ASC
		]]>
	</select>
	<select id="getSuggestionList">
		<![CDATA[
		SELECT DISTINCT 
			name
		FROM 
			books 
		WHERE 
			name LIKE #term#
		ORDER BY name
		]]>
	</select>
	<select id="getLastInsertId">
		<![CDATA[
		select last_insert_id()
		]]>
	</select>
</sqlMap>