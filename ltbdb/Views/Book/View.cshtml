@model ltbdb.Models.BookViewDetailContainer
@using ltbdb.Models
@using ltbdb.Core

@{
	ViewBag.Title = String.Format("Nr. {0} - {1} | {2} | Lustiges Taschenbuch - Datenbank", Model.Book.Number, Model.Book.Name, Model.Book.Category.Name);
	Layout = "~/Views/Shared/_Layout.cshtml";
}

<div style="position: relative;">
	<div style="position: absolute; top: 0px; right: 0px; color: #6b7b95; font-size: 8pt;">
		Kategorie: <a href="@Url.Action("view", "category", new { id = Model.Book.Category.Id })">@Model.Book.Category.Name</a> | Hinzugefügt am: @String.Format(new System.Globalization.CultureInfo("de-DE"), "{0:dddd, d. MMM yyyy}", Model.Book.Created)
		@if(Request.IsAuthenticated) {
		@:| <a href="@Url.Action("edit", "book", new { id = Model.Book.Id } )">Bearbeiten</a> | <span class="pointer" id="delete" data-id="@Model.Book.Id" data-title="Buch Nr. @Model.Book.Number - @Model.Book.Name">Löschen</span>
		}
	</div>
	<h2>Nr. @Model.Book.Number - @Model.Book.Name</h2>
	<div class="details">
		<div style="float: left;">
			@if(Model.Book.Stories.Count() > 0) {
			<ul class="story-list">
			@foreach (var story in Model.Book.Stories)
			{
				<li>@story</li>
			}
			</ul>
			} else {
			<span class="story-list">
				Keine Inhalte angegeben. 
			</span>
			}
		</div>
		<div style="float: right; position: relative; width: 200px; height: 200px; text-align: center;">
			<a id="image-big" href="@ImageStore.GetWebPath(Model.Book.Filename)" title="Nr. @Model.Book.Number - @Model.Book.Name (@Model.Book.Category.Name)" data-jbox-image="image">
				<img src="@ImageStore.GetWebPath(Model.Book.Filename, ImageType.PreferThumbnail)" alt="Cover" />
			</a>
		</div>
	</div>

	<h2>Tags</h2>
	<div class="tag-container">
		@foreach (var tag in Model.Tags)
		{
		<div class="tag" style="position: relative;">
			@if(Request.IsAuthenticated) {
			<span class="tag-remove" data-id="@Model.Book.Id" data-tagid="@tag.Id" title="Dieses Tag entfernen."><i class="material-icons bigger">delete</i></span>
			}
			<a href="@Url.Action("view", "tag", new { id = tag.Name})" title="">@tag.Name</a>
		</div>
		}
		@if(Request.IsAuthenticated) {
		<div class="tag-add" id="tag-add">
			<span id="addtag" data-id="@Model.Book.Id" title="Tags hinzufügen."><i class="material-icons bigger">add_box</i></span>
		</div>
		}
	</div>
</div>
<script type="text/javascript">
	$(function () {
		$('#addtag').click(function (e) {
			jbox_tag.open({
				target: $(this)
			})
		});

		var tag_template = '<div class="tag" style="position: relative;">\
								<span class="tag-remove" data-id="{1}" data-tagid="{2}"><i class="material-icons bigger" title="Dieses Tag entfernen.">delete</i></span>\
								<a href="/tag/{0}" title="">{0}</a>\
							</div>';

		$('#add-button').click(function (e) {
			data = {
				id: $('#t').attr('data-id'),
				tags: $('#t').val()
			};

			$.ajax({
				cache: false,
				url: '/api/tag/add',
				type: 'POST',
				data: data,
				dataType: 'json',
				statusCode: {
					403: function () {
						location.href = '/account/login?ReturnUrl=' + encodeURIComponent(location.pathname);
					},
					404: function () {
						alert('Resource not found.');
					}
				},
				success: function (data) {
					$.each(data, function (i, item) {
						var t = tag_template.replace(/\{0\}/g, item.Name).replace(/\{1\}/g, item.Book).replace(/\{2\}/g, item.Id);
						$(t).insertBefore('#tag-add');
					});
					jbox_tag.close();
				}
			});
		});

		var id = null;

		var jbox_delete = new jBox('Modal', {
			attach: $('#delete'),
			content: $('#delete-msg-box'),
			overlay: true,
			closeOnClick: 'body',
			preventDefault: true,
			closeButton: 'title',
			getTitle: 'data-title',
			onOpen: function () {
				$('#error').text('');
				id = this.source.attr('data-id');
			},
			onClose: function () {
				id = null;
			}
		});

		$('#delete-button').click(function () {
			if (id == null)
				return;

			$.ajax({
				type: "POST",
				url: '/api/book/delete/' + id,
				statusCode: {
					403: function () {
						location.href = '/account/login?ReturnUrl=' + encodeURIComponent(location.pathname);
					},
					404: function () {
						alert('Resource not found');
					}
				},
				success: function (data) {
					if (data.success == false) {
						$('#error').text('Buch konnte nicht gelöscht werden');
					} else {
						$('#error').text('');
						jbox_delete.close();
						location.href = '/';
					}
				}
			})
		});
	});
</script>

<div id="delete-msg-box" style="display: none;">
	<p>
		Dieses Buch wirklich löschen?
	</p>
	<p id="error" style="color: #ff0000;">
	</p>
	<div>
		<input id="delete-button" class="button-red" type="button" value="Löschen" />
	</div>
</div>

<div id="tag-msg-box" style="display: none;" class="tag-form">
	<div>
		<input id="t" type="text" name="tags" value="" placeholder="Tags" data-id="@Model.Book.Id" />
	</div>
	<div style="padding-top: 10px;">
		<input id="add-button" type="submit" value="Hinzufügen" />
	</div>
</div>